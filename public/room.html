<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Комната просмотра</title>
    <link rel="stylesheet" href="/css/videoPlayer.css">
    <link rel="stylesheet" href="/css/room.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="room-layout">
        <!-- Error overlay -->
        <div id="error-message" class="error-overlay">
            <div class="error-content">
                <h1>Ошибка: такой комнаты не существует!</h1>
                <a href="/" class="home-link">Вернуться на главную</a>
            </div>
        </div>
        <div id="overlay" class="overlay">
            <button id="startButton" class="start-button">Начать просмотр</button>
        </div>
        
        <!-- Ваш основной интерфейс страницы -->
        <div id="mainContent" class="main-content">
                <!-- Main room content -->
            <div id="room-container" class="room-content">
                <button id="startButton" style="display:none;">Начать просмотр</button>
                <!-- Header with room info -->
                <header class="room-header">
                    <div class="room-info">
                        <h2>Комната: <span id="room-name"></span></h2>
                        <button id="copy-button" class="copy-btn" title="Скопировать код комнаты">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                    </div>
                </header>

                <!-- Main content area -->
                <main class="room-main">
                    <!-- Search section -->
                    <section class="search-section">
                        <div class="search-container">
                            <input class="search-input" type="url" placeholder="Вставьте ссылку на видео">
                            <button class="search-btn">Поиск</button>
                        </div>
                        
                        <div class="search-results">
                            <!-- Results will be inserted here -->
                        </div>
                    </section>

                    <!-- Video player section -->
                    <section class="player-section">
                        <div class="player-wrapper">
                            <div class="video-container">
                                <!-- Основной видеоэлемент -->
                                <video id="videoPlayer" controls></video>
                                
                                    <!-- Обновленная структура элементов управления -->
                                    <div class="custom-controls" id="customControls">
                                        <div class="progress-bar-container" id="progressContainer">
                                            <div class="progress-bar" id="progressBar">
                                                <div class="progress-thumb" id="progressThumb"></div>
                                            </div>
                                        </div>
                                        <div class="controls-row">
                                        <button class="control-button" id="playPauseButton">
                                            <svg id="playIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                            </svg>
                                            <svg id="pauseIcon" style="display:none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <rect x="6" y="4" width="4" height="16"></rect>
                                                <rect x="14" y="4" width="4" height="16"></rect>
                                            </svg>
                                        </button>
                                        
                                        <div class="volume-container">
                                            <button class="control-button" id="muteButton">
                                                <svg id="volumeIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                                    <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                                                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                                                </svg>
                                                <svg id="muteIcon" style="display:none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                                    <line x1="23" y1="9" x2="17" y2="15"></line>
                                                    <line x1="17" y1="9" x2="23" y2="15"></line>
                                                </svg>
                                            </button>
                                            <div class="volume-slider" id="volumeSlider">
                                                <div class="volume-level" id="volumeLevel"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="time-display" id="timeDisplay">0:00 / 0:00</div>
                                        
                                        <button class="control-button" id="fullscreenButton">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Индикатор загрузки -->
                                <div class="loading-indicator" id="loadingIndicator">
                                    Загрузка...
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Voices and episodes section -->
                    <section class="content-section">
                        <div class="voices-container">
                            <h3>Доступные озвучки</h3>
                            <div class="voices-buttons"></div>
                        </div>
                        
                        <div class="episodes-container">
                            <h3>Список серий</h3>
                            <div class="episodes-buttons"></div>
                        </div>
                    </section>
                </main>
            </div>
        </div>
        </div>
      

    <!-- Scripts -->
    <script src="/js/utils.js"></script>
    <script src="/js/parser.js"></script>
    <script src="/js/videoPlayer.js"></script>
    <script src="/js/room.js"></script>
    <script>
        // const video = document.getElementById('videoPlayer');

        //     document.addEventListener('fullscreenchange', () => {
        //     if (document.fullscreenElement === video) {
        //         document.body.classList.add('video-fullscreen');
        //     } else {
        //         document.body.classList.remove('video-fullscreen');
        //     }
        //     });
                                // Переключение воспроизведения/паузы
            async function setPlay() 
            {
                video.play();
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';
            }

            async function setPause() 
            {
                video.pause();
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
            }    

            // Перемотка видео
            function seekVideo(e) {
                // const rect = progressContainer.getBoundingClientRect();
                // const pos = (e.clientX - rect.left) / rect.width;
                if (video.duration) {
                    video.currentTime = e;
                }
            }
            
        document.addEventListener('DOMContentLoaded', function() {
            // Получаем все необходимые элементы
            const video = document.getElementById('videoPlayer');
            const customControls = document.getElementById('customControls');
            const playPauseButton = document.getElementById('playPauseButton');
            const playIcon = document.getElementById('playIcon');
            const pauseIcon = document.getElementById('pauseIcon');
            const muteButton = document.getElementById('muteButton');
            const volumeIcon = document.getElementById('volumeIcon');
            const muteIcon = document.getElementById('muteIcon');
            const volumeSlider = document.getElementById('volumeSlider');
            const volumeLevel = document.getElementById('volumeLevel');
            const timeDisplay = document.getElementById('timeDisplay');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const fullscreenButton = document.getElementById('fullscreenButton');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const progressThumb = document.getElementById('progressThumb');
            const initialBarHeight = progressBar.offsetHeight;
            const initialThumbSize = progressThumb.offsetWidth;

            window.addEventListener('resize', () => {
                const progressBar = document.getElementById('progressBar');
                const progressThumb = document.getElementById('progressThumb');

                const currentBarHeight = progressBar.offsetHeight;

                // Вычисляем новый размер точки пропорционально изменению высоты полоски
                const scaleFactor = currentBarHeight / initialBarHeight;
                const newThumbSize = initialThumbSize * scaleFactor;

                // Применяем новые размеры к точке
                progressThumb.style.width = `${newThumbSize}px`;
                progressThumb.style.height = `${newThumbSize}px`;

                // Также может потребоваться скорректировать позиционирование,
                // особенно vertical-align (top) и смещение translateX
                progressThumb.style.transform = `translateY(-${newThumbSize / 2}px) translateX(50%)`;
                // Возможно, придется скорректировать right, если вы его использовали
            });

            //Тестовый блок
            //Тестовый блок
            //Тестовый блок

            //     const video = document.getElementById('videoPlayer');
            // const progressContainer = document.querySelector('.progress-bar-container');
            // const progressBar = document.querySelector('.progress-bar');

            let isDraggingProgressBar = false;
            let isDraggingThumb = false;

            function updateProgressBarFromMouseEvent(event) {
                const rect = progressContainer.getBoundingClientRect();
                let position = (event.clientX - rect.left) / rect.width;
                position = Math.max(0, Math.min(1, position)); // Ограничиваем от 0 до 1
                video.currentTime = position * video.duration;
                updateProgressBarUI(position);
            }

            function updateProgressBarUI(position) {
                progressBar.style.width = `${position * 100}%`;
                //progressThumb.style.right = `${(1 - position) * -12 + -6}px`; // Корректировка позиции индикатора
            }

            function handleMouseDownProgressBar(event) {
                isDraggingProgressBar = true;
                updateProgressBarFromMouseEvent(event);
            }

            function handleMouseMoveProgressBar(event) {
                if (isDraggingProgressBar) {
                    updateProgressBarFromMouseEvent(event);
                }
            }

            function handleMouseUpProgressBar() {
                isDraggingProgressBar = false;
                progressThumb.classList.remove('dragging');
            }

            // Обработчики для перетаскивания индикатора
            function handleMouseDownThumb(event) {
                isDraggingThumb = true;
                progressThumb.classList.add('dragging');
                // Предотвращаем выделение текста при перетаскивании
                event.preventDefault();
            }

            function handleMouseMoveThumb(event) {
                if (isDraggingThumb) {
                    updateProgressBarFromMouseEvent(event);
                }
            }

            function handleMouseUpThumb() {
                isDraggingThumb = false;
                progressThumb.classList.remove('dragging');
            }

            progressContainer.addEventListener('mousedown', handleMouseDownProgressBar);
            document.addEventListener('mousemove', handleMouseMoveProgressBar);
            document.addEventListener('mouseup', handleMouseUpProgressBar);

            progressThumb.addEventListener('mousedown', handleMouseDownThumb);
            document.addEventListener('mousemove', handleMouseMoveThumb);
            document.addEventListener('mouseup', handleMouseUpThumb);

            // Обработчики для сенсорных устройств (аналогично, но с touches[0])
            progressContainer.addEventListener('touchstart', (event) => {
                isDraggingProgressBar = true;
                updateProgressBarFromMouseEvent({ clientX: event.touches[0].clientX });
            });

            document.addEventListener('touchmove', (event) => {
                if (isDraggingProgressBar) {
                    updateProgressBarFromMouseEvent({ clientX: event.touches[0].clientX });
                } else if (isDraggingThumb) {
                    updateProgressBarFromMouseEvent({ clientX: event.touches[0].clientX });
                }
            });

            document.addEventListener('touchend', () => {
                isDraggingProgressBar = false;
                isDraggingThumb = false;
                progressThumb.classList.remove('dragging');
            });

            progressThumb.addEventListener('touchstart', (event) => {
                isDraggingThumb = true;
                progressThumb.classList.add('dragging');
            });

            // Обновление прогресс-бара и положения индикатора во время воспроизведения
            video.addEventListener('timeupdate', () => {
                if (!isDraggingProgressBar && !isDraggingThumb && video.duration) {
                    const progress = video.currentTime / video.duration;
                    updateProgressBarUI(progress);
                }
            });

            // Инициализация положения индикатора при загрузке видео
            video.addEventListener('loadedmetadata', () => {
                if (video.duration) {
                    updateProgressBarUI(0); // Начальное положение
                }
            });

            const volumeContainer = document.querySelector('.volume-slider');
            const volumeBar = document.querySelector('.volume-level');
            ///Звук
            let isDraggingVolume = false;

            function updateVolume(event) {
                const rect = volumeContainer.getBoundingClientRect();
                let volumeLevel = (event.clientX - rect.left) / rect.width;
                if (volumeLevel < 0) volumeLevel = 0;
                if (volumeLevel > 1) volumeLevel = 1;
                video.volume = volumeLevel;
                volumeBar.style.width = `${volumeLevel * 100}%`;
            }

            function handleMouseDownVolume(event) {
                isDraggingVolume = true;
                updateVolume(event);
            }

            function handleMouseMoveVolume(event) {
                if (isDraggingVolume) {
                    updateVolume(event);
                }
            }

            function handleMouseUpVolume() {
                isDraggingVolume = false;
            }

            volumeContainer.addEventListener('mousedown', handleMouseDownVolume);
            document.addEventListener('mousemove', handleMouseMoveVolume);
            document.addEventListener('mouseup', handleMouseUpVolume);

            // Обработчики для сенсорных устройств
            volumeContainer.addEventListener('touchstart', (event) => {
                isDraggingVolume = true;
                updateVolume(event.touches[0]);
            });

            document.addEventListener('touchmove', (event) => {
                if (isDraggingVolume) {
                    updateVolume(event.touches[0]);
                }
            });

            document.addEventListener('touchend', () => {
                isDraggingVolume = false;
            });

            // Дополнительно: обработка клика по контейнеру громкости для быстрой установки уровня
            volumeContainer.addEventListener('click', (event) => {
                updateVolume(event);
            });
            //Тестовый блок
            //Тестовый блок
            //Тестовый блок
            // Отключаем встроенные элементы управления и добавляем атрибуты
            video.controls = false;
            video.setAttribute('playsinline', '');
            video.setAttribute('webkit-playsinline', '');
            
            
            // Отображаем наши кастомные контролы, скрываем встроенные
            customControls.style.display = 'flex';
            
            // Функция форматирования времени
            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
            }
            
            // Обновление шкалы прогресса и времени
            function updateProgress() {
                if (video.duration) {
                    const percent = (video.currentTime / video.duration) * 100;
                    progressBar.style.width = `${percent}%`;
                    timeDisplay.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;
                }
            }
            

            
            // Переключение звука
            function toggleMute() {
                video.muted = !video.muted;
                updateVolumeUI();
            }
            
            // Обновление UI громкости
            function updateVolumeUI() {
                if (video.muted || video.volume === 0) {
                    volumeIcon.style.display = 'none';
                    muteIcon.style.display = 'block';
                    volumeLevel.style.width = '0%';
                } else {
                    volumeIcon.style.display = 'block';
                    muteIcon.style.display = 'none';
                    volumeLevel.style.width = `${video.volume * 100}%`;
                }
            }
            
            // Настройка громкости
            function setVolume(e) {
                const rect = volumeSlider.getBoundingClientRect();
                let pos = (e.clientX - rect.left) / rect.width;
                pos = Math.max(0, Math.min(1, pos));
                video.volume = pos;
                video.muted = false;
                updateVolumeUI();
            }
            
            function toggleFullscreen() 
            {
                const wrapper = document.querySelector('.player-wrapper');
                
                if (!document.fullscreenElement && 
                    !document.mozFullScreenElement && 
                    !document.webkitFullscreenElement && 
                    !document.msFullscreenElement) {
                    // Вход в полноэкранный режим
                    if (wrapper.requestFullscreen) {
                        wrapper.requestFullscreen();
                    } else if (wrapper.msRequestFullscreen) {
                        wrapper.msRequestFullscreen();
                    } else if (wrapper.mozRequestFullScreen) {
                        wrapper.mozRequestFullScreen();
                    } else if (wrapper.webkitRequestFullscreen) {
                        wrapper.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
                    }
                } else {
                    // Выход из полноэкранного режима
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.msExitFullscreen) {
                        document.msExitFullscreen();
                    } else if (document.mozCancelFullScreen) {
                        document.mozCancelFullScreen();
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    }
                }
            }

            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
            document.addEventListener('mozfullscreenchange', handleFullscreenChange);
            document.addEventListener('MSFullscreenChange', handleFullscreenChange);

            function handleFullscreenChange() {
                const wrapper = document.querySelector('.player-wrapper');
                const video = document.getElementById('videoPlayer');
                
                if (document.fullscreenElement || 
                    document.webkitFullscreenElement || 
                    document.mozFullScreenElement || 
                    document.msFullscreenElement) {
                    // Вошли в полноэкранный режим
                    wrapper.classList.add('fullscreen-active');
                    video.style.width = '100%';
                    video.style.height = '100%';
                    video.style.maxHeight = 'none';
                } else {
                    // Вышли из полноэкранного режима
                    wrapper.classList.remove('fullscreen-active');
                    video.style.width = '100%';
                    video.style.height = 'auto';
                    video.style.maxHeight = '70vh';
                }
                
                // Принудительно обновляем дисплей, чтобы все стили применились корректно
                setTimeout(function() {
                    window.dispatchEvent(new Event('resize'));
                }, 50);
            }
            // Добавьте этот обработчик события resize
            window.addEventListener('resize', function() {
                // При изменении размера окна может потребоваться обновление размеров видео
                const wrapper = document.querySelector('.player-wrapper');
                const video = document.getElementById('videoPlayer');
                
                if (document.fullscreenElement || 
                    document.webkitFullscreenElement || 
                    document.mozFullScreenElement || 
                    document.msFullscreenElement) {
                    // Если в полноэкранном режиме
                    video.style.width = '100%';
                    video.style.height = '100%';
                }
            });
                        // События для видео
            video.addEventListener('timeupdate', updateProgress);
            video.addEventListener('play', function() {
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';
            });
            video.addEventListener('pause', function() {
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
            });
            video.addEventListener('ended', function() {
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
            });
            video.addEventListener('volumechange', updateVolumeUI);
            video.addEventListener('loadstart', function() {
                loadingIndicator.style.display = 'block';
            });
            video.addEventListener('canplay', function() {
                loadingIndicator.style.display = 'none';
            });
            
            function PlayOrPause(){
                if (video.paused || video.ended) {
                    play();
                } 
                else 
                {
                    pause();
                }
            }

            function Seek(e){
                //console.log(e);
                const rect = progressContainer.getBoundingClientRect();
                const pos = (e.clientX - rect.left) / rect.width;
                seek(pos * video.duration);
            }
            // События для кнопок управления
            playPauseButton.addEventListener('click', PlayOrPause);
            muteButton.addEventListener('click', toggleMute);
            fullscreenButton.addEventListener('click', toggleFullscreen);
            
            // События для прогресс-бара и громкости
            progressContainer.addEventListener('click', Seek);
            volumeSlider.addEventListener('click', setVolume);
            
            // Клик по видео для воспроизведения/паузы
            video.addEventListener('click', PlayOrPause);
            
            // Управление с клавиатуры
            document.addEventListener('keydown', function(e) {
                if (document.activeElement.tagName !== 'INPUT' && 
                    document.activeElement.tagName !== 'TEXTAREA') {
                    switch(e.key) {
                        case ' ':
                        case 'k':
                            togglePlay();
                            e.preventDefault();
                            break;
                        case 'm':
                            toggleMute();
                            e.preventDefault();
                            break;
                        case 'f':
                            toggleFullscreen();
                            e.preventDefault();
                            break;
                        case 'ArrowRight':
                            video.currentTime += 5;
                            e.preventDefault();
                            break;
                        case 'ArrowLeft':
                            video.currentTime -= 5;
                            e.preventDefault();
                            break;
                        case 'ArrowUp':
                            video.volume = Math.min(1, video.volume + 0.1);
                            video.muted = false;
                            updateVolumeUI();
                            e.preventDefault();
                            break;
                        case 'ArrowDown':
                            video.volume = Math.max(0, video.volume - 0.1);
                            updateVolumeUI();
                            e.preventDefault();
                            break;
                    }
                }
            });
            
            // Инициализация начального состояния
            updateVolumeUI();
            
            // Функции для загрузки и воспроизведения видео
            window.loadHlsStream = function(url) {
                if (Hls.isSupported()) {
                    const hls = new Hls();
                    loadingIndicator.style.display = 'block';
                    
                    hls.loadSource(url);
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        loadingIndicator.style.display = 'none';
                        video.play()
                            .then(() => {
                                playIcon.style.display = 'none';
                                pauseIcon.style.display = 'block';
                            })
                            .catch(err => {
                                console.log('Автовоспроизведение заблокировано: ', err);
                            });
                    });
                    
                    hls.on(Hls.Events.ERROR, function(event, data) {
                        if (data.fatal) {
                            switch(data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    console.log('Сетевая ошибка, попытка восстановления...');
                                    hls.startLoad();
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    console.log('Ошибка медиа, попытка восстановления...');
                                    hls.recoverMediaError();
                                    break;
                                default:
                                    console.log('Неустранимая ошибка');
                                    hls.destroy();
                                    break;
                            }
                        }
                    });
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    // Нативная поддержка HLS в Safari
                    video.src = url;
                    video.addEventListener('loadedmetadata', function() {
                        video.play();
                    });
                }
            };
            
            window.loadVideoSource = function(url) {
                loadingIndicator.style.display = 'block';
                video.src = url;
                video.addEventListener('canplay', function onCanPlay() {
                    loadingIndicator.style.display = 'none';
                    video.play()
                        .then(() => {
                            playIcon.style.display = 'none';
                            pauseIcon.style.display = 'block';
                        })
                        .catch(err => {
                            console.log('Автовоспроизведение заблокировано: ', err);
                        });
                    video.removeEventListener('canplay', onCanPlay);
                });
            };
            
            // Публичные методы для управления плеером
            window.customPlayerControls = {
                play: function() {
                    video.play();
                },
                pause: function() {
                    video.pause();
                },
                togglePlay: PlayOrPause,
                setCurrentTime: function(time) {
                    if (time >= 0 && time <= video.duration) {
                        video.currentTime = time;
                    }
                },
                mute: function() {
                    video.muted = true;
                    updateVolumeUI();
                },
                unmute: function() {
                    video.muted = false;
                    updateVolumeUI();
                },
                toggleMute: toggleMute,
                setVolume: function(volume) {
                    if (volume >= 0 && volume <= 1) {
                        video.volume = volume;
                        updateVolumeUI();
                    }
                },
                getPlayer: function() {
                    return video;
                }
            };
            
            // ВАЖНО: Оставляем стандартные элементы управления как запасные
            // на случай если кастомные не работают
            video.addEventListener('error', function() {
                video.controls = true;
                customControls.style.display = 'none';
            });
        });

    

    // Функция для определения типа устройства
    function isMobileDevice() {
        return (window.innerWidth <= 768) || 
            /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    // Настройка для мобильных устройств
    function setupMobileOptimizations() {
        const video = document.getElementById('videoPlayer');
        const customControls = document.getElementById('customControls');
        
        if (isMobileDevice()) {
            // Атрибуты для лучшей поддержки мобильных устройств
            video.setAttribute('playsinline', '');
            video.setAttribute('webkit-playsinline', '');
            video.setAttribute('x-webkit-airplay', 'allow');
            
            // Настройка размеров видео для мобильных устройств
            video.style.objectFit = 'contain';
            
            // Показываем элементы управления при касании видео
            video.addEventListener('touchstart', function() {
                if (customControls.style.opacity !== '1') {
                    showControls();
                } else {
                    hideControlsAfterDelay();
                }
            });
            
            // Улучшаем работу с полноэкранным режимом для iOS
            if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                fullscreenButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (video.webkitEnterFullscreen) {
                        video.webkitEnterFullscreen();
                    } else if (video.requestFullscreen) {
                        video.requestFullscreen();
                    }
                });
            }
        }
    }

    // Функции для показа/скрытия элементов управления
    let controlsTimeout;

    function showControls() {
        const customControls = document.getElementById('customControls');
        customControls.style.opacity = '1';
        customControls.style.transform = 'translateY(0)';
        
        clearTimeout(controlsTimeout);
        hideControlsAfterDelay();
    }

    function hideControls() {
        const customControls = document.getElementById('customControls');
        customControls.style.opacity = '0';
        customControls.style.transform = 'translateY(10px)';
    }

    function hideControlsAfterDelay() {
        clearTimeout(controlsTimeout);
        controlsTimeout = setTimeout(hideControls, 3000); // Скрываем через 3 секунды
    }

    // Показать элементы управления при движении мыши
    document.querySelector('.video-container').addEventListener('mousemove', showControls);

    // Скрыть элементы управления через некоторое время бездействия
    hideControlsAfterDelay();

    // Останавливаем скрытие при наведении на элементы управления
    document.querySelector('.custom-controls').addEventListener('mouseenter', function() {
        clearTimeout(controlsTimeout);
    });

    // Возобновляем скрытие при уходе мыши с элементов управления
    document.querySelector('.custom-controls').addEventListener('mouseleave', hideControlsAfterDelay);

    // Вызываем функцию настройки для мобильных устройств
    setupMobileOptimizations();

    // Обрабатываем изменение ориентации устройства
    window.addEventListener('orientationchange', function() {
        // Обновляем размеры при изменении ориентации
        setTimeout(function() {
            if (document.fullscreenElement || 
                document.webkitFullscreenElement || 
                document.mozFullScreenElement || 
                document.msFullscreenElement) {
                
                const video = document.getElementById('videoPlayer');
                video.style.width = '100%';
                video.style.height = '100%';
                video.style.objectFit = 'contain';
            }
        }, 300); // Небольшая задержка для завершения изменения ориентации
    });
    // Добавьте эту функцию для обработки полноэкранного режима на разных устройствах
    function updateFullscreenUI() {
        const isFullscreen = document.fullscreenElement || 
                            document.webkitFullscreenElement || 
                            document.mozFullScreenElement || 
                            document.msFullscreenElement;
        
        const video = document.getElementById('videoPlayer');
        const wrapper = document.querySelector('.player-wrapper');
        
        if (isFullscreen) {
            // В полноэкранном режиме
            wrapper.classList.add('is-fullscreen');
            video.style.objectFit = 'contain';
            
            // Особая обработка для мобильных устройств
            if (isMobileDevice()) {
                video.style.width = '100%';
                video.style.height = '100%';
                wrapper.style.display = 'flex';
                wrapper.style.alignItems = 'center';
                wrapper.style.justifyContent = 'center';
            }
        } else {
            // Вышли из полноэкранного режима
            wrapper.classList.remove('is-fullscreen');
            
            // Возвращаем стандартные стили
            video.style.objectFit = '';
            
            if (isMobileDevice()) {
                video.style.width = '100%';
                video.style.height = 'auto';
                wrapper.style.display = '';
                wrapper.style.alignItems = '';
                wrapper.style.justifyContent = '';
            }
        }
    }

    // Обновите существующие обработчики событий полноэкранного режима
    document.addEventListener('fullscreenchange', updateFullscreenUI);
    document.addEventListener('webkitfullscreenchange', updateFullscreenUI);
    document.addEventListener('mozfullscreenchange', updateFullscreenUI);
    document.addEventListener('MSFullscreenChange', updateFullscreenUI);

    // Специфическая обработка для iOS Safari
    if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream) {
        const video = document.getElementById('videoPlayer');
        
        // Обработка нажатия кнопки fullscreen для iOS
        document.getElementById('fullscreenButton').addEventListener('click', function(e) {
            e.stopPropagation();
            
            if (video.webkitSupportsFullscreen) {
                video.webkitEnterFullscreen();
            }
        });
        
        // Добавление слушателя для события входа в полноэкранный режим
        video.addEventListener('webkitbeginfullscreen', function() {
            // В Safari на iOS элементы управления видео будут нативными в полноэкранном режиме
        });
        
        // Добавление слушателя для события выхода из полноэкранного режима
        video.addEventListener('webkitendfullscreen', function() {
            // Действия при выходе из полноэкранного режима
        });
    }
            // Добавьте эту функцию в ваш JavaScript
        function optimizeControlsForScreenSize() {
            const screenWidth = window.innerWidth;
            const controlsRow = document.querySelector('.controls-row');
            const volumeContainer = document.querySelector('.volume-container');
            const timeDisplay = document.getElementById('timeDisplay');
            
            // Для очень малых экранов
            if (screenWidth <= 360) {
                // Скрываем контроль громкости на очень малых экранах
                if (volumeContainer) {
                    volumeContainer.style.display = 'none';
                }
                
                // Сокращаем формат времени для экономии места
                if (timeDisplay) {
                    // Заменяем функцию форматирования времени для малых экранов
                    window.formatTimeCompact = function(seconds) {
                        const minutes = Math.floor(seconds / 60);
                        const secs = Math.floor(seconds % 60);
                        return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
                    };
                    
                    // Используем компактную функцию форматирования
                    if (video.duration) {
                        timeDisplay.textContent = `${formatTimeCompact(video.currentTime)}/${formatTimeCompact(video.duration)}`;
                    }
                }
            } else {
                // Возвращаем нормальное отображение для больших экранов
                if (volumeContainer && screenWidth > 480) {
                    volumeContainer.style.display = 'flex';
                }
            }
        }

        // Вызываем функцию при загрузке и изменении размера окна
        window.addEventListener('load', optimizeControlsForScreenSize);
        window.addEventListener('resize', optimizeControlsForScreenSize);

    </script>
</body>
</html>